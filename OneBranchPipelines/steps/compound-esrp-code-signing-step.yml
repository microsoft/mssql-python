#################################################################################
# Licensed to the .NET Foundation under one or more agreements.
# The .NET Foundation licenses this file to you under the MIT license.
# See the LICENSE file in the project root for more information.
#################################################################################

# ESRP Code Signing Step Template
# Signs binary artifacts using Microsoft's Enterprise Signing Service
parameters:
  - name: appRegistrationClientId
    type: string
    displayName: 'App Registration Client ID'
  
  - name: appRegistrationTenantId
    type: string
    displayName: 'App Registration Tenant ID'
  
  - name: artifactType
    type: string
    displayName: 'Artifact type to sign'
    values:
      - 'dll'   # For .pyd, .so, .dylib files
      - 'pkg'   # For .whl, .nupkg files
  
  - name: authAkvName
    type: string
    displayName: 'Azure Key Vault name'
  
  - name: authSignCertName
    type: string
    displayName: 'Signing certificate name'
  
  - name: esrpClientId
    type: string
    displayName: 'ESRP Client ID'
  
  - name: esrpConnectedServiceName
    type: string
    displayName: 'ESRP Connected Service Name'
  
  - name: signPath
    type: string
    displayName: 'Path containing files to sign'

steps:
  # Configure ESRP signing operation based on artifact type
  - pwsh: |
      $artifactType = "${{ parameters.artifactType }}"
      if ($artifactType -eq "dll") {
        Write-Host "##vso[task.setvariable variable=ESRP_OPERATION]SigntoolSign"
        Write-Host "##vso[task.setvariable variable=ESRP_SESSION_CONFIG]session-authenticode"
        Write-Host "Signing native binaries (.pyd, .so, .dylib)"
      } elseif ($artifactType -eq "pkg") {
        Write-Host "##vso[task.setvariable variable=ESRP_OPERATION]NuGetSign"
        Write-Host "##vso[task.setvariable variable=ESRP_SESSION_CONFIG]session-nuget"
        Write-Host "Signing package files (.whl, .nupkg)"
      }
    displayName: 'Configure ESRP Signing Operation'
  
  # Actual ESRP signing task
  # NOTE: Replace 'EsrpSigning@x.x.x' with the actual ESRP task from your organization
  - task: EsrpCodeSigning@2
    displayName: 'ESRP Code Signing - ${{ parameters.artifactType }}'
    inputs:
      ConnectedServiceName: '${{ parameters.esrpConnectedServiceName }}'
      FolderPath: '${{ parameters.signPath }}'
      Pattern: |
        ${{ if eq(parameters.artifactType, 'dll') }}:
          **/*.pyd
          **/*.so
          **/*.dylib
        ${{ if eq(parameters.artifactType, 'pkg') }}:
          **/*.whl
          **/*.nupkg
      signConfigType: 'inlineSignParams'
      inlineOperation: |
        [
          {
            "KeyCode": "${{ parameters.authSignCertName }}",
            "OperationCode": "$(ESRP_OPERATION)",
            "Parameters": {},
            "ToolName": "sign",
            "ToolVersion": "1.0"
          }
        ]
      SessionTimeout: '60'
      MaxConcurrency: '50'
      MaxRetryAttempts: '5'
    env:
      AZURE_CLIENT_ID: ${{ parameters.appRegistrationClientId }}
      AZURE_TENANT_ID: ${{ parameters.appRegistrationTenantId }}
      AZURE_KEYVAULT_NAME: ${{ parameters.authAkvName }}
  
  - script: |
      echo "Signed files in: ${{ parameters.signPath }}"
      ls -R "${{ parameters.signPath }}" || dir /s "${{ parameters.signPath }}"
    displayName: 'List signed files'
    condition: succeededOrFailed()
