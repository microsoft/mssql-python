# ESRP Code Signing Step Template
# Signs binary artifacts using Microsoft's Enterprise Signing Service
# Based on SqlClient ESRP signing implementation
parameters:
  - name: appRegistrationClientId
    type: string
    displayName: 'App Registration Client ID'
  
  - name: appRegistrationTenantId
    type: string
    displayName: 'App Registration Tenant ID'
  
  - name: artifactType
    type: string
    displayName: 'Artifact type to sign'
    values:
      - 'dll'   # For .pyd, .so, .dylib files (native binaries)
      - 'whl'   # For .whl files (Python wheels)
  
  - name: authAkvName
    type: string
    displayName: 'Azure Key Vault name'
  
  - name: authSignCertName
    type: string
    displayName: 'Signing certificate name'
  
  - name: esrpClientId
    type: string
    displayName: 'ESRP Client ID'
  
  - name: esrpConnectedServiceName
    type: string
    displayName: 'ESRP Connected Service Name'
  
  - name: signPath
    type: string
    displayName: 'Path containing files to sign'

steps:
  # Sign native binary files (.pyd, .so, .dylib)
  - ${{ if eq(parameters.artifactType, 'dll') }}:
      - task: EsrpMalwareScanning@5
        displayName: 'ESRP MalwareScanning - Native Binaries'
        inputs:
          ConnectedServiceName: '${{ parameters.esrpConnectedServiceName }}'
          AppRegistrationClientId: '${{ parameters.appRegistrationClientId }}'
          AppRegistrationTenantId: '${{ parameters.appRegistrationTenantId }}'
          EsrpClientId: '${{ parameters.esrpClientId }}'
          UseMSIAuthentication: true
          FolderPath: '${{ parameters.signPath }}'
          Pattern: '*.pyd,*.dll,*.so,*.dylib'
          CleanupTempStorage: 1
          VerboseLogin: 1
      
      - task: EsrpCodeSigning@5
        displayName: 'ESRP CodeSigning - Native Binaries'
        inputs:
          ConnectedServiceName: '${{ parameters.esrpConnectedServiceName }}'
          AppRegistrationClientId: '${{ parameters.appRegistrationClientId }}'
          AppRegistrationTenantId: '${{ parameters.appRegistrationTenantId }}'
          EsrpClientId: '${{ parameters.esrpClientId }}'
          UseMSIAuthentication: true
          AuthAKVName: '${{ parameters.authAkvName }}'
          AuthSignCertName: '${{ parameters.authSignCertName }}'
          FolderPath: '${{ parameters.signPath }}'
          Pattern: '*.pyd,*.dll,*.so,*.dylib'
          signConfigType: inlineSignParams
          inlineOperation: |
            [
              {
                "keyCode": "CP-230012",
                "operationSetCode": "SigntoolSign",
                "parameters": [
                  {
                    "parameterName": "OpusName",
                    "parameterValue": "mssql-python"
                  },
                  {
                    "parameterName": "OpusInfo",
                    "parameterValue": "http://www.microsoft.com"
                  },
                  {
                    "parameterName": "FileDigest",
                    "parameterValue": "/fd \"SHA256\""
                  },
                  {
                    "parameterName": "PageHash",
                    "parameterValue": "/NPH"
                  },
                  {
                    "parameterName": "TimeStamp",
                    "parameterValue": "/tr \"http://rfc3161.gtm.corp.microsoft.com/TSS/HttpTspServer\" /td sha256"
                  }
                ],
                "toolName": "sign",
                "toolVersion": "1.0"
              },
              {
                "keyCode": "CP-230012",
                "operationSetCode": "SigntoolVerify",
                "parameters": [],
                "toolName": "sign",
                "toolVersion": "1.0"
              }
            ]
  
  # Sign Python wheel files (.whl)
  - ${{ if eq(parameters.artifactType, 'whl') }}:
      - task: EsrpMalwareScanning@5
        displayName: 'ESRP MalwareScanning - Python Wheels'
        inputs:
          ConnectedServiceName: '${{ parameters.esrpConnectedServiceName }}'
          AppRegistrationClientId: '${{ parameters.appRegistrationClientId }}'
          AppRegistrationTenantId: '${{ parameters.appRegistrationTenantId }}'
          EsrpClientId: '${{ parameters.esrpClientId }}'
          UseMSIAuthentication: true
          FolderPath: '${{ parameters.signPath }}'
          Pattern: '*.whl'
          CleanupTempStorage: 1
          VerboseLogin: 1
      
      - task: EsrpCodeSigning@5
        displayName: 'ESRP CodeSigning - Python Wheels'
        inputs:
          ConnectedServiceName: '${{ parameters.esrpConnectedServiceName }}'
          AppRegistrationClientId: '${{ parameters.appRegistrationClientId }}'
          AppRegistrationTenantId: '${{ parameters.appRegistrationTenantId }}'
          EsrpClientId: '${{ parameters.esrpClientId }}'
          UseMSIAuthentication: true
          AuthAKVName: '${{ parameters.authAkvName }}'
          AuthSignCertName: '${{ parameters.authSignCertName }}'
          FolderPath: '${{ parameters.signPath }}'
          Pattern: '*.whl'
          signConfigType: inlineSignParams
          inlineOperation: |
            [
              {
                "keyCode": "CP-230012",
                "operationSetCode": "SigntoolSign",
                "parameters": [
                  {
                    "parameterName": "OpusName",
                    "parameterValue": "mssql-python"
                  },
                  {
                    "parameterName": "OpusInfo",
                    "parameterValue": "http://www.microsoft.com"
                  },
                  {
                    "parameterName": "FileDigest",
                    "parameterValue": "/fd \"SHA256\""
                  },
                  {
                    "parameterName": "PageHash",
                    "parameterValue": "/NPH"
                  },
                  {
                    "parameterName": "TimeStamp",
                    "parameterValue": "/tr \"http://rfc3161.gtm.corp.microsoft.com/TSS/HttpTspServer\" /td sha256"
                  }
                ],
                "toolName": "sign",
                "toolVersion": "1.0"
              },
              {
                "keyCode": "CP-230012",
                "operationSetCode": "SigntoolVerify",
                "parameters": [],
                "toolName": "sign",
                "toolVersion": "1.0"
              }
            ]
  
  # List signed files (platform-specific)
  - ${{ if eq(parameters.artifactType, 'dll') }}:
      # Windows - use cmd syntax
      - script: |
          echo Signed files in: ${{ parameters.signPath }}
          dir /s /b "${{ parameters.signPath }}\*.whl" "${{ parameters.signPath }}\*.pyd" "${{ parameters.signPath }}\*.dll" 2>nul
        displayName: 'List signed files (Windows)'
        condition: succeededOrFailed()
  
  - ${{ else }}:
      # Linux/macOS - use bash syntax
      - bash: |
          echo "Signed files in: ${{ parameters.signPath }}"
          if [ -d "${{ parameters.signPath }}" ]; then
            find "${{ parameters.signPath }}" -type f \( -name "*.whl" -o -name "*.pyd" -o -name "*.dll" -o -name "*.so" -o -name "*.dylib" \) -ls
          else
            echo "Directory not found: ${{ parameters.signPath }}"
          fi
        displayName: 'List signed files (Linux/macOS)'
        condition: succeededOrFailed()
