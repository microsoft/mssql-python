# Symbol Publishing Step Template
# Publishes PDB symbols to Azure DevOps Symbol Server and Microsoft Symbol Publishing Service
parameters:
  - name: SymbolsFolder
    type: string
    default: '$(ob_outputDirectory)\symbols'

steps:
  # Set AccountName for SqlClientDrivers organization (separate PowerShell task like JDBC)
  - task: PowerShell@2
    displayName: 'Set Symbol.AccountName to SqlClientDrivers'
    inputs:
      targetType: inline
      # NOTE: we're setting PAT in this step since Pat:$(System.AccessToken) doesn't work in PublishSymbols@2 task directly
      # Tried using env: parameter on PublishSymbols@2 but it didn't work
      # This is a workaround to set it via script, and setting as a secret variable
      script: |
        Write-Host "##vso[task.setvariable variable=ArtifactServices.Symbol.AccountName;]SqlClientDrivers"
        Write-Host "##vso[task.setvariable variable=ArtifactServices.Symbol.Pat;issecret=true;]$env:SYSTEM_ACCESSTOKEN"
        # Verify System.AccessToken is available
        if (-not $env:SYSTEM_ACCESSTOKEN) {
          Write-Error "SYSTEM_ACCESSTOKEN is not available. Ensure 'Allow scripts to access the OAuth token' is enabled in the pipeline settings."
        } else {
          Write-Host "SYSTEM_ACCESSTOKEN is available and will be used for symbol publishing."
        }
    env:
      SYSTEM_ACCESSTOKEN: $(System.AccessToken)
  
  - task: PublishSymbols@2
    displayName: 'Push Symbols to SqlClientDrivers ADO Organization'
    inputs:
      SymbolsFolder: '${{ parameters.SymbolsFolder }}'
      SearchPattern: '**/*.pdb'
      IndexSources: false
      SymbolServerType: TeamServices
      SymbolsMaximumWaitTime: 10
      SymbolsProduct: mssql-python
      SymbolsVersion: $(Build.BuildId)
  
  # Publish to Microsoft Symbol Publishing Service (External)
  # This step finds the request name created by PublishSymbols@2 task above and publishes to internal/public servers
  # The PublishSymbols@2 task uploads symbols and creates a request; this step marks it for publishing
  # Project name must be registered with Symbol team via IcM incident
  # Reference: https://www.osgwiki.com/wiki/Symbols_Publishing_Pipeline_to_SymWeb_and_MSDL#Step_3:_Project_Setup
  - task: AzureCLI@2
    displayName: 'Publish symbols to Microsoft Symbol Publishing Service'
    condition: succeeded()
    env:
      SymbolServer: '$(SymbolServer)'
      SymbolTokenUri: '$(SymbolTokenUri)'
    inputs:
      azureSubscription: 'SymbolsPublishing-msodbcsql-mssql-python'
      scriptType: ps
      scriptLocation: inlineScript
      inlineScript: |
        $symbolServer = $env:SymbolServer
        $tokenUri = $env:SymbolTokenUri
        $projectName = "mssql-python"

        # Get the access token for the symbol publishing service
        $symbolPublishingToken = az account get-access-token --resource $tokenUri --query accessToken -o tsv
        echo ">  1.Symbol publishing token acquired."

        # Get the logs from the current pipeline run to find the request name created by PublishSymbols@2
        echo "Searching for request name created by PublishSymbols@2 task..."
        $logList = Invoke-RestMethod -Uri "$(System.CollectionUri)$(System.TeamProject)/_apis/build/builds/$(Build.BuildId)/logs?api-version=7.1" -Method GET -Headers @{ Authorization = "Bearer $(System.AccessToken)" } -ContentType "application/json"

        $requestName = $null
        $logList.value | ForEach-Object {
            $id = $_.id
            $log = Invoke-RestMethod -Uri "$(System.CollectionUri)$(System.TeamProject)/_apis/build/builds/$(Build.BuildId)/logs/$id" -Method GET -Headers @{ Authorization = "Bearer $(System.AccessToken)" } -ContentType "application/json"
            
            echo $log > log.txt
            # PublishSymbols@2 creates a request with pattern like: Request 'mssql-python/.../...'
            $request = Select-String -Path log.txt -Pattern "Request '.*'" -ErrorAction SilentlyContinue
            
            if ($request -and $request -match "'mssql-python\/.*'") {
                $requestName = (-Split $Matches[0])[0].Replace("'","")
                echo "Found request name: $requestName"
            }
        }

        if (-not $requestName) {
            echo "##[error]Could not find request name in build logs. The PublishSymbols@2 task may have failed or not created a request."
            exit 1
        }

        echo ">  2.Request name found from PublishSymbols@2 task."

        # Register the request name (if not already registered by PublishSymbols@2)
        echo "Registering the request name ..."
        $requestNameRegistration = @{ requestName = $requestName }
        $requestNameRegistrationBody = $requestNameRegistration | ConvertTo-Json -Compress
        try {
            Invoke-RestMethod -Method POST -Uri "https://$symbolServer.trafficmanager.net/projects/$projectName/requests" -Headers @{ Authorization = "Bearer $symbolPublishingToken" } -ContentType "application/json" -Body $requestNameRegistrationBody
            echo ">  3.Registration of request name succeeded."
        } catch {
            echo "Registration may have already existed (this is okay): $($_.Exception.Message)"
        }

        # Publish the symbols to internal and public servers
        echo "Publishing the symbols to internal and public servers..."
        $publishSymbols = @{
            publishToInternalServer = $true
            publishToPublicServer = $true
        }
        $publishSymbolsBody = $publishSymbols | ConvertTo-Json -Compress
        echo "Publishing symbols request body: $publishSymbolsBody"
        
        try {
            $response = Invoke-RestMethod -Method POST -Uri "https://$symbolServer.trafficmanager.net/projects/$projectName/requests/$requestName" -Headers @{ Authorization = "Bearer $symbolPublishingToken" } -ContentType "application/json" -Body $publishSymbolsBody
            echo ">  4.Request to publish symbols succeeded."
            echo "Response: $($response | ConvertTo-Json)"
        } catch {
            echo "##[error]Failed to publish symbols. Status Code: $($_.Exception.Response.StatusCode.value__)"
            echo "##[error]Error Message: $($_.Exception.Message)"
            if ($_.ErrorDetails.Message) {
                echo "##[error]Error Details: $($_.ErrorDetails.Message)"
            }
            throw
        }

        echo ">  3.Request to publish symbols succeeded."

        # The following REST calls are used to check publishing status.
        echo ">  4.Checking the status of the request ..."

        Invoke-RestMethod -Method GET -Uri "https://$symbolServer.trafficmanager.net/projects/$projectName/requests/$requestName" -Headers @{ Authorization = "Bearer $symbolPublishingToken" } -ContentType "application/json"
        
        echo "Use below tables to interpret the values of xxxServerStatus and xxxServerResult fields from the response."
        
        echo "PublishingStatus"
        echo "-----------------"
        echo "0 NotRequested; The request has not been requested to publish."
        echo "1 Submitted; The request is submitted to be published"
        echo "2 Processing; The request is still being processed"
        echo "3 Completed; The request has been completed processing. It can be failed or successful. Check PublishingResult to get more details"
        
        echo "PublishingResult"
        echo "-----------------"
        echo "0 Pending; The request has not completed or has not been requested."
        echo "1 Succeeded; The request has published successfully"
        echo "2 Failed; The request has failed to publish"
        echo "3 Cancelled; The request was cancelled"
