# Symbol Publishing Step Template
# Publishes PDB symbols to Azure DevOps Symbol Server and Microsoft Symbol Publishing Service
parameters:
  - name: SymbolsFolder
    type: string
    default: '$(ob_outputDirectory)\symbols'

steps:
  # Set AccountName for SqlClientDrivers organization (separate PowerShell task like JDBC)
  - task: PowerShell@2
    displayName: 'Set Symbol.AccountName to SqlClientDrivers'
    inputs:
      targetType: inline
      script: |
        Write-Host "##vso[task.setvariable variable=ArtifactServices.Symbol.AccountName;]SqlClientDrivers"
        Write-Host "##vso[task.setvariable variable=ArtifactServices.Symbol.Pat;]$env:SYSTEM_ACCESSTOKEN"
        # Verify System.AccessToken is available
        if (-not $env:SYSTEM_ACCESSTOKEN) {
          Write-Error "SYSTEM_ACCESSTOKEN is not available. Ensure 'Allow scripts to access the OAuth token' is enabled in the pipeline settings."
        } else {
          Write-Host "SYSTEM_ACCESSTOKEN is available and will be used for symbol publishing."
        }
    env:
      SYSTEM_ACCESSTOKEN: $(System.AccessToken)
  
  - task: PublishSymbols@2
    displayName: 'Push Symbols to SqlClientDrivers ADO Organization'
    inputs:
      SymbolsFolder: '${{ parameters.SymbolsFolder }}'
      SearchPattern: '**/*.pdb'
      IndexSources: false
      SymbolServerType: TeamServices
      SymbolsMaximumWaitTime: 10
      SymbolsProduct: mssql-python
      SymbolsVersion: $(Build.BuildId)
  
  # Publish to Microsoft Symbol Publishing Service (External)
  # Note: This requires additional variable group with SymbolServer, SymbolTokenUri variables
  # Similar to SqlClient's 'akv-variables-v2' group containing SymbolsPublishServer, SymbolsPublishTokenUri
  - task: AzureCLI@2
    displayName: 'Publish symbols to Microsoft Symbol Publishing Service'
    condition: succeeded()
    env:
      SymbolServer: '$(SymbolServer)'
      SymbolTokenUri: '$(SymbolTokenUri)'
      requestName: '$(System.TeamProject)-$(Build.SourceBranchName)-$(Build.DefinitionName)-$(Build.BuildId)'
    inputs:
      azureSubscription: 'SymbolsPublishing-msodbcsql-mssql-python'
      scriptType: ps
      scriptLocation: inlineScript
      inlineScript: |
        # Should be true by default for internal server
        $publishToInternalServer = $true 
        $publishToPublicServer = $false

        echo "Publishing request name: $(requestName)"
        echo "Publish to internal server: $publishToInternalServer"
        echo "Publish to public server: $publishToPublicServer"      

        $symbolServer = '$(SymbolServer)'
        $tokenUri = '$(SymbolTokenUri)'
        $projectName = "mssql-python"

        # Get the access token for the symbol publishing service
        $symbolPublishingToken = az account get-access-token --resource $tokenUri --query accessToken -o tsv

        echo ">  1.Symbol publishing token acquired."

        echo "Registering the request name ..."
        $requestName = '$(requestName)'
        $requestNameRegistrationBody = "{'requestName': '$requestName'}"
        Invoke-RestMethod -Method POST -Uri "https://$symbolServer.trafficmanager.net/projects/$projectName/requests" -Headers @{ Authorization = "Bearer $symbolPublishingToken" } -ContentType "application/json" -Body $requestNameRegistrationBody

        echo ">  2.Registration of request name succeeded."

        echo "Publishing the symbols ..."
        $publishSymbolsBody = "{'publishToInternalServer': $publishToInternalServer, 'publishToPublicServer': $publishToPublicServer}"
        echo "Publishing symbols request body: $publishSymbolsBody"
        Invoke-RestMethod -Method POST -Uri "https://$symbolServer.trafficmanager.net/projects/$projectName/requests/$requestName" -Headers @{ Authorization = "Bearer $symbolPublishingToken" } -ContentType "application/json" -Body $publishSymbolsBody

        echo ">  3.Request to publish symbols succeeded."

        # The following REST calls are used to check publishing status.
        echo ">  4.Checking the status of the request ..."

        Invoke-RestMethod -Method GET -Uri "https://$symbolServer.trafficmanager.net/projects/$projectName/requests/$requestName" -Headers @{ Authorization = "Bearer $symbolPublishingToken" } -ContentType "application/json"
        
        echo "Use below tables to interpret the values of xxxServerStatus and xxxServerResult fields from the response."
        
        echo "PublishingStatus"
        echo "-----------------"
        echo "0 NotRequested; The request has not been requested to publish."
        echo "1 Submitted; The request is submitted to be published"
        echo "2 Processing; The request is still being processed"
        echo "3 Completed; The request has been completed processing. It can be failed or successful. Check PublishingResult to get more details"
        
        echo "PublishingResult"
        echo "-----------------"
        echo "0 Pending; The request has not completed or has not been requested."
        echo "1 Succeeded; The request has published successfully"
        echo "2 Failed; The request has failed to publish"
        echo "3 Cancelled; The request was cancelled"
