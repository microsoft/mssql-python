# Windows Build Job Template
# Builds Python wheels and native bindings for Windows (x64 and ARM64)
parameters:
  - name: oneBranchType
    type: string
    default: 'Official'
  
  - name: signingEnabled
    type: boolean
    default: true
  
  - name: buildConfiguration
    type: string
    default: 'Release'

jobs:
  - job: BuildWindowsWheels
    displayName: 'Build Windows Wheels'
    pool:
      type: windows
    
    strategy:
      matrix:
        # Python 3.10 (only x64)
        py310_x64:
          pythonVersion: '3.10'
          shortPyVer: '310'
          architecture: 'x64'
          targetArch: 'x64'
        
        # Python 3.11
        py311_x64:
          pythonVersion: '3.11'
          shortPyVer: '311'
          architecture: 'x64'
          targetArch: 'x64'
        py311_arm64:
          pythonVersion: '3.11'
          shortPyVer: '311'
          architecture: 'x64'
          targetArch: 'arm64'
        
        # Python 3.12
        py312_x64:
          pythonVersion: '3.12'
          shortPyVer: '312'
          architecture: 'x64'
          targetArch: 'x64'
        py312_arm64:
          pythonVersion: '3.12'
          shortPyVer: '312'
          architecture: 'x64'
          targetArch: 'arm64'
        
        # Python 3.13
        py313_x64:
          pythonVersion: '3.13'
          shortPyVer: '313'
          architecture: 'x64'
          targetArch: 'x64'
        py313_arm64:
          pythonVersion: '3.13'
          shortPyVer: '313'
          architecture: 'x64'
          targetArch: 'arm64'
    
    variables:
      ob_outputDirectory: '$(Build.ArtifactStagingDirectory)'
    
    steps:
      - task: UsePythonVersion@0
        inputs:
          versionSpec: '$(pythonVersion)'
          architecture: '$(architecture)'
          addToPath: true
        displayName: 'Use Python $(pythonVersion) ($(architecture))'
      
      - script: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install cmake pybind11
        displayName: 'Install dependencies'
      
      - powershell: |
          sqllocaldb create MSSQLLocalDB
          sqllocaldb start MSSQLLocalDB
        displayName: 'Start LocalDB instance'
      
      - powershell: |
          sqlcmd -S "(localdb)\MSSQLLocalDB" -Q "CREATE DATABASE TestDB"
          sqlcmd -S "(localdb)\MSSQLLocalDB" -Q "CREATE LOGIN testuser WITH PASSWORD = '$(DB_PASSWORD)'"
          sqlcmd -S "(localdb)\MSSQLLocalDB" -d TestDB -Q "CREATE USER testuser FOR LOGIN testuser"
          sqlcmd -S "(localdb)\MSSQLLocalDB" -d TestDB -Q "ALTER ROLE db_owner ADD MEMBER testuser"
        displayName: 'Setup database and user'
        env:
          DB_PASSWORD: $(DB_PASSWORD)
      
      - task: DownloadPipelineArtifact@2
        condition: eq(variables['targetArch'], 'arm64')
        inputs:
          buildType: 'specific'
          project: '$(System.TeamProject)'
          definition: 2162
          buildVersionToDownload: 'latest'
          artifactName: 'mssql-python-arm64-libs'
          targetPath: '$(Build.SourcesDirectory)\mssql_python\pybind\python_libs\arm64'
        displayName: 'Download ARM64 Python libs'
      
      - script: |
          echo "Python Version: $(pythonVersion)"
          echo "Short Tag: $(shortPyVer)"
          echo "Architecture: Host=$(architecture), Target=$(targetArch)"
          
          cd "$(Build.SourcesDirectory)\mssql_python\pybind"
          
          REM Override lib path for ARM64
          if "$(targetArch)"=="arm64" (
            echo Using arm64-specific Python library...
            set CUSTOM_PYTHON_LIB_DIR=$(Build.SourcesDirectory)\mssql_python\pybind\python_libs\arm64
          )
          
          call build.bat $(targetArch)
          call keep_single_arch.bat $(targetArch)
          
          cd ..\..
        displayName: 'Build PYD for $(targetArch)'
        continueOnError: false
      
      - powershell: |
          Write-Host "Running pytests to validate bindings"
          if ("$(targetArch)" -eq "arm64") {
            Write-Host "Skipping pytests on Windows ARM64"
          } else {
            python -m pytest -v
          }
        displayName: 'Run pytests'
        env:
          DB_CONNECTION_STRING: 'Server=(localdb)\MSSQLLocalDB;Database=TestDB;Uid=testuser;Pwd=$(DB_PASSWORD);TrustServerCertificate=yes'
      
      - task: CopyFiles@2
        inputs:
          SourceFolder: '$(Build.SourcesDirectory)\mssql_python\pybind\build\$(targetArch)\py$(shortPyVer)\Release'
          Contents: 'ddbc_bindings.cp$(shortPyVer)-*.pyd'
          TargetFolder: '$(ob_outputDirectory)\bindings\windows'
        displayName: 'Copy PYD files'
      
      - task: CopyFiles@2
        inputs:
          SourceFolder: '$(Build.SourcesDirectory)\mssql_python\pybind\build\$(targetArch)\py$(shortPyVer)\Release'
          Contents: 'ddbc_bindings.cp$(shortPyVer)-*.pdb'
          TargetFolder: '$(ob_outputDirectory)\symbols'
        displayName: 'Copy PDB files'
      
      - script: |
          python -m pip install --upgrade pip wheel setuptools
          set ARCHITECTURE=$(targetArch)
          python setup.py bdist_wheel
        displayName: 'Build wheel package'
      
      - task: CopyFiles@2
        inputs:
          SourceFolder: '$(Build.SourcesDirectory)\dist'
          Contents: '*.whl'
          TargetFolder: '$(ob_outputDirectory)\wheels'
        displayName: 'Copy wheel files'
      
      # Malware scanning
      - template: /OneBranchPipelines/steps/malware-scanning-step.yml@self
        parameters:
          scanPath: '$(ob_outputDirectory)'
          artifactType: 'dll'
      
      # ESRP Code Signing for DLLs (only for Official builds)
      - ${{ if and(eq(parameters.signingEnabled, true), eq(parameters.oneBranchType, 'Official')) }}:
          - template: /OneBranchPipelines/steps/compound-esrp-code-signing-step.yml@self
            parameters:
              appRegistrationClientId: '$(SigningAppRegistrationClientId)'
              appRegistrationTenantId: '$(SigningAppRegistrationTenantId)'
              artifactType: 'dll'
              authAkvName: '$(SigningAuthAkvName)'
              authSignCertName: '$(SigningAuthSignCertName)'
              esrpClientId: '$(SigningEsrpClientId)'
              esrpConnectedServiceName: '$(SigningEsrpConnectedServiceName)'
              signPath: '$(ob_outputDirectory)\bindings\windows'
      
      # ESRP Code Signing for Python Wheels (only for Official builds)
      - ${{ if and(eq(parameters.signingEnabled, true), eq(parameters.oneBranchType, 'Official')) }}:
          - template: /OneBranchPipelines/steps/compound-esrp-code-signing-step.yml@self
            parameters:
              appRegistrationClientId: '$(SigningAppRegistrationClientId)'
              appRegistrationTenantId: '$(SigningAppRegistrationTenantId)'
              artifactType: 'whl'
              authAkvName: '$(SigningAuthAkvName)'
              authSignCertName: '$(SigningAuthSignCertName)'
              esrpClientId: '$(SigningEsrpClientId)'
              esrpConnectedServiceName: '$(SigningEsrpConnectedServiceName)'
              signPath: '$(ob_outputDirectory)\wheels'
