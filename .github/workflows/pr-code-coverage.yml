name: PR Code Coverage

on:
  pull_request:
    branches:
      - main

jobs:
  coverage-report:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Wait for ADO build to succeed
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          API_URL="https://dev.azure.com/sqlclientdrivers/public/_apis/build/builds?definitions=2128&queryOrder=queueTimeDescending&%24top=10&api-version=7.1-preview.7"

          echo "Waiting for Azure DevOps build for PR #$PR_NUMBER ..."

          for i in {1..100}; do
            echo "Attempt $i/100: Checking build status..."
            
            # Fetch API response with error handling
            API_RESPONSE=$(curl -s "$API_URL")
            
            # Check if response is valid JSON
            if ! echo "$API_RESPONSE" | jq . >/dev/null 2>&1; then
              echo "âŒ Invalid JSON response from Azure DevOps API"
              echo "Response received: $API_RESPONSE"
              echo "This usually indicates the Azure DevOps pipeline has failed or API is unavailable"
              exit 1
            fi
            
            # Parse build info safely
            BUILD_INFO=$(echo "$API_RESPONSE" | jq -c --arg PR "$PR_NUMBER" '[.value[]? | select(.triggerInfo["pr.number"]?==$PR)] | .[0] // empty' 2>/dev/null)
            
            if [[ -n "$BUILD_INFO" && "$BUILD_INFO" != "null" && "$BUILD_INFO" != "empty" ]]; then
              STATUS=$(echo "$BUILD_INFO" | jq -r '.status // "unknown"')
              RESULT=$(echo "$BUILD_INFO" | jq -r '.result // "unknown"')
              BUILD_ID=$(echo "$BUILD_INFO" | jq -r '.id // "unknown"')
              WEB_URL=$(echo "$BUILD_INFO" | jq -r '._links.web.href // "unknown"')
              
              echo "Found build: ID=$BUILD_ID, Status=$STATUS, Result=$RESULT"

              if [[ "$STATUS" == "completed" ]]; then
                if [[ "$RESULT" == "succeeded" ]]; then
                  echo "âœ… Build $BUILD_ID succeeded: $WEB_URL"
                  echo "ADO_URL=$WEB_URL" >> $GITHUB_ENV
                  echo "BUILD_ID=$BUILD_ID" >> $GITHUB_ENV
                  break
                else
                  echo "âŒ Azure DevOps build $BUILD_ID failed with result: $RESULT"
                  echo "ğŸ”— Build URL: $WEB_URL"
                  echo "This coverage workflow cannot proceed when the main build fails."
                  exit 1
                fi
              else
                echo "â³ Build $BUILD_ID is still $STATUS..."
              fi
            else
              echo "â³ No build found for PR #$PR_NUMBER yet... (attempt $i/100)"
            fi

            if [[ $i -eq 100 ]]; then
              echo "âŒ Timeout: No build found for PR #$PR_NUMBER after 100 attempts"
              echo "This may indicate the Azure DevOps pipeline was not triggered or failed to start"
              exit 1
            fi

            sleep 20
          done

      - name: Download and parse coverage report
        run: |
          BUILD_ID=${{ env.BUILD_ID }}
          ARTIFACTS_URL="https://dev.azure.com/SqlClientDrivers/public/_apis/build/builds/$BUILD_ID/artifacts?api-version=7.1-preview.5"
          
          echo "ğŸ“¥ Fetching artifacts for build $BUILD_ID..."
          
          # Fetch artifacts with error handling
          ARTIFACTS_RESPONSE=$(curl -s "$ARTIFACTS_URL")
          
          # Check if response is valid JSON
          if ! echo "$ARTIFACTS_RESPONSE" | jq . >/dev/null 2>&1; then
            echo "âŒ Invalid JSON response from artifacts API"
            echo "Response received: $ARTIFACTS_RESPONSE"
            echo "This indicates the Azure DevOps build may not have completed successfully or artifacts are not available"
            exit 1
          fi
          
          # Find the coverage report artifact
          COVERAGE_ARTIFACT=$(echo "$ARTIFACTS_RESPONSE" | jq -r '.value[]? | select(.name | test("Code Coverage Report")) | .resource.downloadUrl // empty' 2>/dev/null)
          
          if [[ -n "$COVERAGE_ARTIFACT" && "$COVERAGE_ARTIFACT" != "null" && "$COVERAGE_ARTIFACT" != "empty" ]]; then
            echo "ğŸ“Š Downloading coverage report..."
            if ! curl -L "$COVERAGE_ARTIFACT" -o coverage-report.zip --fail --silent; then
              echo "âŒ Failed to download coverage report from Azure DevOps"
              echo "This indicates the coverage artifacts may not be available or accessible"
              exit 1
            fi
            
            if ! unzip -q coverage-report.zip; then
              echo "âŒ Failed to extract coverage report zip file"
              echo "The downloaded artifact may be corrupted"
              exit 1
            fi
            
            # Find the main index.html file
            INDEX_FILE=$(find . -name "index.html" -path "*/Code Coverage Report*" | head -1)
            
            if [[ -f "$INDEX_FILE" ]]; then
              echo "ğŸ” Parsing coverage data from $INDEX_FILE..."
              
              # Debug: Show relevant parts of the HTML
              echo "Debug: Looking for coverage data..."
              grep -n "cardpercentagebar\|Covered lines\|Coverable lines" "$INDEX_FILE" | head -10
              
              # Extract coverage metrics using simpler, more reliable patterns
              OVERALL_PERCENTAGE=$(grep -o 'cardpercentagebar[0-9]*">[0-9]*%' "$INDEX_FILE" | head -1 | grep -o '[0-9]*%')
              COVERED_LINES=$(grep -A1 "Covered lines:" "$INDEX_FILE" | grep -o 'title="[0-9]*"' | head -1 | grep -o '[0-9]*')
              TOTAL_LINES=$(grep -A1 "Coverable lines:" "$INDEX_FILE" | grep -o 'title="[0-9]*"' | head -1 | grep -o '[0-9]*')
              
              # Fallback method if the above doesn't work
              if [[ -z "$OVERALL_PERCENTAGE" ]]; then
                echo "Trying alternative parsing method..."
                OVERALL_PERCENTAGE=$(grep -o 'large.*">[0-9]*%' "$INDEX_FILE" | head -1 | grep -o '[0-9]*%')
              fi
              
              echo "Extracted values:"
              echo "OVERALL_PERCENTAGE=$OVERALL_PERCENTAGE"
              echo "COVERED_LINES=$COVERED_LINES"
              echo "TOTAL_LINES=$TOTAL_LINES"
              
              # Validate that we got the essential data
              if [[ -z "$OVERALL_PERCENTAGE" ]]; then
                echo "âŒ Could not extract coverage percentage from the report"
                echo "The coverage report format may have changed or be incomplete"
                exit 1
              fi
              
              echo "COVERAGE_PERCENTAGE=$OVERALL_PERCENTAGE" >> $GITHUB_ENV
              echo "COVERED_LINES=${COVERED_LINES:-N/A}" >> $GITHUB_ENV
              echo "TOTAL_LINES=${TOTAL_LINES:-N/A}" >> $GITHUB_ENV
              
              # Extract top files with low coverage - improved approach
              echo "ğŸ“‹ Extracting file-level coverage..."
              
              # Extract file coverage data more reliably
              LOW_COVERAGE_FILES=$(grep -o '<td><a href="[^"]*">[^<]*</a></td><td class="right">[0-9]*</td><td class="right">[0-9]*</td><td class="right">[0-9]*</td><td class="right">[0-9]*</td><td title="[^"]*" class="right">[0-9]*\.[0-9]*%' "$INDEX_FILE" | \
                sed 's/<td><a href="[^"]*">\([^<]*\)<\/a><\/td>.*class="right">\([0-9]*\.[0-9]*\)%/\1: \2%/' | \
                sort -t: -k2 -n | head -5)
              
              # Alternative method if above fails
              if [[ -z "$LOW_COVERAGE_FILES" ]]; then
                echo "Trying alternative file parsing..."
                LOW_COVERAGE_FILES=$(grep -E "\.py.*[0-9]+\.[0-9]+%" "$INDEX_FILE" | \
                  grep -o "[^>]*\.py[^<]*</a>.*[0-9]*\.[0-9]*%" | \
                  sed 's/\([^<]*\)<\/a>.*\([0-9]*\.[0-9]*\)%/\1: \2%/' | \
                  sort -t: -k2 -n | head -5)
              fi
              
              echo "LOW_COVERAGE_FILES<<EOF" >> $GITHUB_ENV
              echo "${LOW_COVERAGE_FILES:-No detailed file data available}" >> $GITHUB_ENV
              echo "EOF" >> $GITHUB_ENV
              
              echo "âœ… Coverage data extracted successfully"
            else
              echo "âŒ Could not find index.html in coverage report"
              echo "Available files in the coverage report:"
              find . -name "*.html" | head -10 || echo "No HTML files found"
              exit 1
            fi
          else
            echo "âŒ Could not find coverage report artifact"
            echo "Available artifacts from the build:"
            echo "$ARTIFACTS_RESPONSE" | jq -r '.value[]?.name // "No artifacts found"' 2>/dev/null || echo "Could not parse artifacts list"
            echo "This indicates the Azure DevOps build may not have generated coverage reports"
            exit 1
          fi

      - name: Comment coverage summary on PR
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: Code Coverage Report
          message: |
            # ğŸ“Š Code Coverage Report
            
            <table>
            <tr>
            <td align="center" width="100">
            
            ### ğŸ¯ Coverage
            ## **${{ env.COVERAGE_PERCENTAGE }}**
            
            </td>
            <td width="20"></td>
            <td>
            
            **ğŸ“ˆ Lines Covered:** `${{ env.COVERED_LINES }}` out of `${{ env.TOTAL_LINES }}`  
            **ğŸ“ Project:** `mssql-python`  
            **ğŸ” Parser:** `Cobertura`  
            
            </td>
            </tr>
            </table>
            
            ---
            
            ### ğŸ“‹ Files Needing Attention
            <details>
            <summary>ğŸ“‰ <strong>Files with lowest coverage</strong> (click to expand)</summary>
            <br>
            
            ```diff
            ${{ env.LOW_COVERAGE_FILES }}
            ```
            
            > ğŸ’¡ **Tip:** Focus on improving coverage for these files to boost overall project health
            
            </details>
            
            ---
            
            <div align="center">
            
            ### ğŸ”— Quick Links
            
            | ï¿½ **Build Status** | ğŸ“Š **Coverage Details** |
            |:---:|:---:|
            | [View Azure DevOps Build](${{ env.ADO_URL }}) | [Browse Full Coverage Report](${{ env.ADO_URL }}&view=codecoverage-tab) |
            
            </div>
            
            <sub>ğŸ¤– This report was automatically generated from Azure DevOps build artifacts</sub>
