name: Linting Check

on:
  pull_request:
    types: [opened, edited, reopened, synchronize]

    paths:
      - '**.py'
      - '**.cpp'
      - '**.c'
      - '**.h'
      - '**.hpp'
      - '.github/workflows/lint-check.yml'
      - 'pyproject.toml'
      - '.clang-format'
  push:
    branches:
      - main

permissions:
  pull-requests: write

jobs:
  python-lint:
    name: Python Linting
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
        cache: 'pip'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install black pylint autopep8
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        
    - name: Check Python formatting with Black
      run: |
        echo "::group::Black Formatting Check"
        black --check --line-length=100 --diff mssql_python/ tests/ || {
          echo "::error::Black formatting issues found. Run 'black --line-length=100 mssql_python/ tests/' locally to fix."
          exit 1
        }
        echo "::endgroup::"
        
    - name: Lint with Pylint
      run: |
        echo "::group::Pylint Analysis"
        pylint mssql_python/ --max-line-length=100 \
          --disable=fixme,no-member,too-many-arguments,too-many-positional-arguments,invalid-name,useless-parent-delegation \
          --exit-zero --output-format=colorized --reports=y || true
        echo "::endgroup::"
        
    - name: Check Type Hints (mypy)
      run: |
        echo "::group::Type Checking"
        pip install mypy
        mypy mssql_python/ --ignore-missing-imports --no-strict-optional --check-untyped-defs || {
          echo "::warning::Type checking found potential issues. Review the output above."
        }
        echo "::endgroup::"
      continue-on-error: true

  cpp-lint:
    name: C++ Linting
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python (for cpplint)
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
        
    - name: Install clang-format
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-format
        clang-format --version
        
    - name: Install cpplint
      run: |
        python -m pip install --upgrade pip
        pip install cpplint
        
    - name: Check C++ formatting with clang-format
      run: |
        echo "::group::clang-format Check"
        # Check formatting without Werror (informational only)
        find mssql_python/pybind -type f \( -name "*.cpp" -o -name "*.c" -o -name "*.h" -o -name "*.hpp" \) | while read file; do
          echo "Checking $file"
          clang-format --dry-run "$file" 2>&1 || true
        done
        
        echo "✅ clang-format check completed (informational only)"
        echo "::endgroup::"
      continue-on-error: true
        
    - name: Lint with cpplint
      run: |
        echo "::group::cpplint Check"
        python -m cpplint \
          --filter=-legal/copyright,-build/include_subdir,-build/c++11 \
          --linelength=100 \
          --recursive \
          --quiet \
          mssql_python/pybind 2>&1 | tee cpplint_output.txt || true
        
        # Count errors and warnings
        ERROR_COUNT=$(grep -c "Total errors found:" cpplint_output.txt || echo "0")
        
        if [ -s cpplint_output.txt ] && grep -q "Total errors found:" cpplint_output.txt; then
          TOTAL_ERRORS=$(grep "Total errors found:" cpplint_output.txt | awk '{print $4}')
          echo "::warning::cpplint found $TOTAL_ERRORS issues. These are informational and don't block the PR."
          
          # Show summary but don't fail (informational only)
          echo "cpplint found $TOTAL_ERRORS style guideline issues (not blocking)"
        else
          echo "✅ cpplint check passed with minimal issues"
        fi
        echo "::endgroup::"
      continue-on-error: true

  lint-summary:
    name: Linting Summary
    runs-on: ubuntu-latest
    needs: [python-lint, cpp-lint]
    if: always()
    
    steps:
    - name: Check results
      run: |
        echo "## Linting Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Check Results" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.python-lint.result }}" == "success" ]; then
          echo "✅ **Python Formatting (Black):** PASSED" >> $GITHUB_STEP_SUMMARY
        else
          echo "❌ **Python Formatting (Black):** FAILED - Please run Black formatter" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "ℹ️ **Python Linting (Pylint):** Informational only" >> $GITHUB_STEP_SUMMARY
        echo "ℹ️ **C++ Linting (clang-format, cpplint):** Informational only" >> $GITHUB_STEP_SUMMARY
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Required Actions" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Black formatting must pass (blocking)" >> $GITHUB_STEP_SUMMARY
        echo "- ℹ️ Other linting issues are warnings and won't block PR" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### How to Fix" >> $GITHUB_STEP_SUMMARY
        echo "1. Save all files in VS Code (Ctrl+S) - auto-formatting will fix most issues" >> $GITHUB_STEP_SUMMARY
        echo "2. Or run manually: \`black --line-length=100 mssql_python/ tests/\`" >> $GITHUB_STEP_SUMMARY
        echo "3. For C++: \`clang-format -i mssql_python/pybind/*.cpp\`" >> $GITHUB_STEP_SUMMARY
        
    - name: Fail if Python formatting failed
      if: needs.python-lint.result != 'success'
      run: |
        echo "::error::Python Black formatting check failed. Please format your Python files."
        exit 1
