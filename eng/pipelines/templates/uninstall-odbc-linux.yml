parameters:
  - name: distroName
    type: string
  - name: packageManager
    type: string
  - name: targetArch
    type: string

steps:
- script: |
    if [ "${{ parameters.packageManager }}" = "apt" ]; then
      docker exec build-container-${{ parameters.distroName }}-${{ parameters.targetArch }} bash -c "
        export DEBIAN_FRONTEND=noninteractive
        apt-get remove --purge -y msodbcsql18 mssql-tools18 unixodbc-dev
        rm -rf /opt/microsoft/msodbcsql /usr/bin/sqlcmd /usr/bin/bcp
        rm -f /lib/x86_64-linux-gnu/libodbcinst.so.2 /lib/aarch64-linux-gnu/libodbcinst.so.2
        odbcinst -u -d -n 'ODBC Driver 18 for SQL Server' || true
        
        # Verify bundled driver
        echo 'Verifying bundled driver library:'
        if [ '${{ parameters.targetArch }}' = 'x86_64' ]; then
          ldd mssql_python/libs/linux/debian_ubuntu/x86_64/lib/libmsodbcsql-18.5.so.1.1
        else
          ldd mssql_python/libs/linux/debian_ubuntu/arm64/lib/libmsodbcsql-18.5.so.1.1
        fi
      "
    elif [ "${{ parameters.packageManager }}" = "apk" ]; then
      docker exec build-container-${{ parameters.distroName }}-${{ parameters.targetArch }} sh -c "
        apk del msodbcsql18 mssql-tools18 unixodbc-dev || true
        rm -rf /opt/microsoft/msodbcsql /usr/bin/sqlcmd /usr/bin/bcp
        rm -f /usr/lib/libodbcinst.so.2
        odbcinst -u -d -n 'ODBC Driver 18 for SQL Server' || true
        
        # Verify bundled driver
        echo 'Verifying bundled driver library:'
        if [ '${{ parameters.targetArch }}' = 'x86_64' ]; then
          ldd mssql_python/libs/linux/alpine/x86_64/lib/libmsodbcsql-18.5.so.1.1
        else
          ldd mssql_python/libs/linux/alpine/arm64/lib/libmsodbcsql-18.5.so.1.1
        fi
      "
    else
      # RHEL/DNF
      docker exec build-container-${{ parameters.distroName }}-${{ parameters.targetArch }} bash -c "
        dnf remove -y msodbcsql18 mssql-tools18 unixODBC-devel
        rm -rf /opt/microsoft/msodbcsql /usr/bin/sqlcmd /usr/bin/bcp
        rm -f /lib64/libodbcinst.so.2
        odbcinst -u -d -n 'ODBC Driver 18 for SQL Server' || true
        
        # Verify bundled driver
        echo 'Verifying bundled driver library:'
        if [ '${{ parameters.targetArch }}' = 'x86_64' ]; then
          ldd mssql_python/libs/linux/rhel/x86_64/lib/libmsodbcsql-18.5.so.1.1
        else
          ldd mssql_python/libs/linux/rhel/arm64/lib/libmsodbcsql-18.5.so.1.1
        fi
      "
    fi
  displayName: 'Uninstall ODBC Driver for testing'
