parameters:
  - name: distroName
    type: string
  - name: packageManager
    type: string
  - name: targetArch
    type: string

steps:
- script: |
    if [ "${{ parameters.packageManager }}" = "apt" ]; then
      docker exec build-container-${{ parameters.distroName }}-${{ parameters.targetArch }} bash -c "
        export DEBIAN_FRONTEND=noninteractive
        
        # Configure Microsoft repo
        if [ '${{ parameters.distroName }}' = 'Ubuntu' ]; then
          curl -sSL -O https://packages.microsoft.com/config/ubuntu/22.04/packages-microsoft-prod.deb
        else
          curl -sSL -O https://packages.microsoft.com/config/debian/12/packages-microsoft-prod.deb
        fi
        
        dpkg -i packages-microsoft-prod.deb || true
        rm packages-microsoft-prod.deb
        apt-get update
        
        # Install ODBC driver and tools
        ACCEPT_EULA=Y apt-get install -y msodbcsql18 mssql-tools18 unixodbc-dev
      "
    elif [ "${{ parameters.packageManager }}" = "apk" ]; then
      docker exec build-container-${{ parameters.distroName }}-${{ parameters.targetArch }} bash -c "
        # Detect architecture
        case \$(uname -m) in
          x86_64) arch='amd64' ;;
          arm64|aarch64) arch='arm64' ;;
          *) echo 'Unsupported architecture'; exit 1 ;;
        esac
        
        # Download and verify packages
        curl -O https://download.microsoft.com/download/fae28b9a-d880-42fd-9b98-d779f0fdd77f/msodbcsql18_18.5.1.1-1_\${arch}.apk
        curl -O https://download.microsoft.com/download/7/6d/76de322a-d860-4894-9945-f0cc5d6a45f8/mssql-tools18_18.4.1.1-1_\${arch}.apk
        curl -O https://download.microsoft.com/download/fae28b9a-d880-42fd-9b98-d779f0fdd77f/msodbcsql18_18.5.1.1-1_\${arch}.sig
        curl -O https://download.microsoft.com/download/7/6d/76de322a-d860-4894-9945-f0cc5d6a45f8/mssql-tools18_18.4.1.1-1_\${arch}.sig
        
        # Verify and install
        curl https://packages.microsoft.com/keys/microsoft.asc | gpg --import -
        gpg --verify msodbcsql18_18.5.1.1-1_\${arch}.sig msodbcsql18_18.5.1.1-1_\${arch}.apk
        gpg --verify mssql-tools18_18.4.1.1-1_\${arch}.sig mssql-tools18_18.4.1.1-1_\${arch}.apk
        
        apk add --allow-untrusted msodbcsql18_18.5.1.1-1_\${arch}.apk mssql-tools18_18.4.1.1-1_\${arch}.apk
        rm -f msodbcsql18_18.5.1.1-1_\${arch}.* mssql-tools18_18.4.1.1-1_\${arch}.*
        
        export PATH=\"\$PATH:/opt/mssql-tools18/bin\"
        echo 'export PATH=\"\$PATH:/opt/mssql-tools18/bin\"' >> ~/.bashrc
      "
    else
      # RHEL/DNF
      docker exec build-container-${{ parameters.distroName }}-${{ parameters.targetArch }} bash -c "
        # Configure Microsoft repo
        curl -sSL -O https://packages.microsoft.com/config/rhel/9/packages-microsoft-prod.rpm
        rpm -Uvh packages-microsoft-prod.rpm
        rm packages-microsoft-prod.rpm
        dnf update -y
        
        # Install ODBC driver and tools
        ACCEPT_EULA=Y dnf install -y msodbcsql18 mssql-tools18 unixODBC-devel
      "
    fi
  displayName: 'Install ODBC Driver'
