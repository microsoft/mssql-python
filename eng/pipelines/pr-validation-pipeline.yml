name: pr-validation-pipeline

# Trigger the pipeline on merge to main branch
trigger:
  branches:
    include:
      - main

pr:
  branches:
    include:
      - main

jobs:
# ===== PYTHON 3.14 TESTING ONLY =====

- job: BuildWindowsWheels_Python314
  pool:
    vmImage: 'windows-latest'
  displayName: 'Build Windows Python 3.14 -'
  strategy:
    matrix:
      py314_x64:
        pythonVersion: '3.14'
        shortPyVer: '314'
        architecture: 'x64'
        targetArch: 'x64'
      py314_arm64:
        pythonVersion: '3.14'
        shortPyVer: '314'
        architecture: 'x64'
        targetArch: 'arm64'

  steps:
    - powershell: |
        # Download and install Python 3.14 x64
        $installerUrl = "https://www.python.org/ftp/python/3.14.0/python-3.14.0a2-amd64.exe"
        $installerPath = "$(Build.SourcesDirectory)\python314-x64-installer.exe"
        $installDir = "C:\Python314"
        
        Write-Host "Downloading Python 3.14 x64 installer from: $installerUrl"
        Invoke-WebRequest -Uri $installerUrl -OutFile $installerPath -UseBasicParsing
        
        Write-Host "Installing Python 3.14 x64 to: $installDir"
        Start-Process -FilePath $installerPath -ArgumentList "/quiet", "InstallAllUsers=1", "PrependPath=1", "Include_test=0", "TargetDir=$installDir" -Wait
        
        Write-Host "Adding Python to PATH"
        $env:Path = "$installDir;$installDir\Scripts;" + $env:Path
        [Environment]::SetEnvironmentVariable("Path", $env:Path, [System.EnvironmentVariableTarget]::Machine)
        
        python --version
        
        Remove-Item -Path $installerPath -Force
      displayName: 'Install Python 3.14 x64'

    - script: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install cmake pybind11
      displayName: 'Install dependencies'
    
    - script: |
        choco install sqlserver-odbcdriver -y
      displayName: 'Install SQL Server ODBC Driver'

    - powershell: |
        sqllocaldb create MSSQLLocalDB
        sqllocaldb start MSSQLLocalDB
      displayName: 'Start LocalDB instance'

    - powershell: |
        sqlcmd -S "(localdb)\MSSQLLocalDB" -Q "CREATE DATABASE TestDB"
        sqlcmd -S "(localdb)\MSSQLLocalDB" -Q "CREATE LOGIN testuser WITH PASSWORD = '$(DB_PASSWORD)'"
        sqlcmd -S "(localdb)\MSSQLLocalDB" -d TestDB -Q "CREATE USER testuser FOR LOGIN testuser"
        sqlcmd -S "(localdb)\MSSQLLocalDB" -d TestDB -Q "ALTER ROLE db_owner ADD MEMBER testuser"
      displayName: 'Setup database and user'
      env:
        DB_PASSWORD: $(DB_PASSWORD)

    - powershell: |
        # Download Python 3.14 ARM64 installer and extract libs (without installing)
        $installerUrl = "https://www.python.org/ftp/python/3.14.0/python-3.14.0a2-arm64.exe"
        $installerPath = "$(Build.SourcesDirectory)\python314-arm64-installer.exe"
        $extractPath = "$(Build.SourcesDirectory)\python314-arm64-temp"
        $destPath = "$(Build.SourcesDirectory)\mssql_python\pybind\python_libs\arm64"
        
        Write-Host "Downloading Python 3.14 ARM64 installer from: $installerUrl"
        Invoke-WebRequest -Uri $installerUrl -OutFile $installerPath -UseBasicParsing
        
        Write-Host "Extracting installer to temp folder: $extractPath"
        # Use 7zip or built-in tools to extract the MSI from the installer
        Start-Process -FilePath $installerPath -ArgumentList "/layout", $extractPath, "/quiet" -Wait
        
        Start-Sleep -Seconds 10
        
        # Find libs directory in extracted files
        Write-Host "Searching for libs directory in extracted files..."
        $libsDir = Get-ChildItem -Path $extractPath -Recurse -Directory -Filter "libs" -ErrorAction SilentlyContinue | Select-Object -First 1
        
        if ($libsDir) {
          Write-Host "Found libs at: $($libsDir.FullName)"
          New-Item -ItemType Directory -Force -Path $destPath | Out-Null
          Copy-Item -Path "$($libsDir.FullName)\*" -Destination $destPath -Recurse -Force
          
          # Also get DLLs
          $dllFiles = Get-ChildItem -Path $extractPath -Recurse -Filter "*.dll" -ErrorAction SilentlyContinue | Where-Object { $_.Name -like "python*" -or $_.Name -like "vcruntime*" }
          foreach ($dll in $dllFiles) {
            Copy-Item -Path $dll.FullName -Destination $destPath -Force
          }
        } else {
          Write-Warning "libs directory not found in extracted files"
        }
        
        Write-Host "`nContents of $destPath :"
        Get-ChildItem $destPath -ErrorAction SilentlyContinue | ForEach-Object { Write-Host "  - $($_.Name)" }
        
        if (Test-Path "$destPath\python314.lib") {
          Write-Host "`nâœ“ python314.lib found"
        } else {
          Write-Error "python314.lib not found!"
          exit 1
        }
        
        # Cleanup
        Remove-Item -Path $installerPath -Force -ErrorAction SilentlyContinue
        Remove-Item -Path $extractPath -Recurse -Force -ErrorAction SilentlyContinue
      condition: eq(variables['targetArch'], 'arm64')
      displayName: 'Extract Python 3.14 ARM64 libs (no installation)'

    - script: |
        echo "Python Version: $(pythonVersion)"
        echo "Short Tag: $(shortPyVer)"
        echo "Architecture: Host=$(architecture), Target=$(targetArch)"

        cd "$(Build.SourcesDirectory)\mssql_python\pybind"

        if "$(targetArch)"=="arm64" (
          echo Using arm64-specific Python library...
          set CUSTOM_PYTHON_LIB_DIR=$(Build.SourcesDirectory)\mssql_python\pybind\python_libs\arm64
        )

        call build.bat $(targetArch)
        call keep_single_arch.bat $(targetArch)

        cd ..\..
      displayName: 'Build PYD for $(targetArch)'
      continueOnError: false

    - powershell: |
        Write-Host "Running pytests to validate bindings"
        if ("$(targetArch)" -eq "arm64") {
          Write-Host "Skipping pytests on Windows ARM64"
        } else {
          python -m pytest -v
        }
      displayName: 'Run pytests'
      env:
        DB_CONNECTION_STRING: 'Server=(localdb)\MSSQLLocalDB;Database=TestDB;Uid=testuser;Pwd=$(DB_PASSWORD);TrustServerCertificate=yes'

    - task: CopyFiles@2
      inputs:
        SourceFolder: '$(Build.SourcesDirectory)\mssql_python'
        Contents: 'ddbc_bindings.cp$(shortPyVer)-*.pyd'
        TargetFolder: '$(Build.ArtifactStagingDirectory)\ddbc-bindings\windows'
      displayName: 'Place PYD file into artifacts directory'

    - script: |
        python -m pip install --upgrade pip
        pip install wheel setuptools
        set ARCHITECTURE=$(targetArch)
        python setup.py bdist_wheel
      displayName: 'Build wheel package for Python $(pythonVersion) ($(targetArch))'
    
    - task: CopyFiles@2
      inputs:
        SourceFolder: '$(Build.SourcesDirectory)\dist'
        Contents: '*.whl'
        TargetFolder: '$(Build.ArtifactStagingDirectory)\dist'
      displayName: 'Collect wheel package'    

    - task: PublishBuildArtifacts@1
      condition: succeededOrFailed()
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)\ddbc-bindings'
        ArtifactName: 'mssql-python-ddbc-bindings-py314'
        publishLocation: 'Container'
      displayName: 'Publish PYDs as artifacts'

    - task: PublishBuildArtifacts@1
      condition: eq(variables['targetArch'], 'arm64')
      inputs:
        PathtoPublish: '$(Build.SourcesDirectory)\mssql_python\pybind\python_libs\arm64'
        ArtifactName: 'mssql-python-arm64-libs-py314'
        publishLocation: 'Container'
      displayName: 'Publish arm64 libs as artifacts'
    
    - task: PublishBuildArtifacts@1
      condition: succeededOrFailed()
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)\dist'
        ArtifactName: 'mssql-python-wheels-dist-py314'
        publishLocation: 'Container'
      displayName: 'Publish wheels as artifacts'

- job: BuildMacOSWheels_Python314
  pool:
    vmImage: 'macos-latest'
  displayName: 'Build macOS Python 3.14 - Universal2'

  steps:
    - task: UsePythonVersion@0
      inputs:
        versionSpec: '3.14'
        addToPath: true
        githubToken: $(GITHUB_TOKEN)
      displayName: 'Use Python 3.14 (Universal2)'

    - script: |
        brew update
        brew uninstall cmake --ignore-dependencies || echo "CMake not installed or already removed"
        brew install cmake
      displayName: 'Install CMake'

    - script: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install cmake pybind11
      displayName: 'Install dependencies'

    - script: |
        echo "Python Version: 3.14"
        echo "Building Universal2 Binary"
        cd "$(Build.SourcesDirectory)/mssql_python/pybind"
        ./build.sh
      displayName: 'Build .so file'
      continueOnError: false

    - task: CopyFiles@2
      inputs:
        SourceFolder: '$(Build.SourcesDirectory)/mssql_python'
        Contents: '*.so'
        TargetFolder: '$(Build.ArtifactStagingDirectory)/ddbc-bindings/macOS'
      displayName: 'Place .so file into artifacts directory'

    - script: |
        brew update
        brew install docker colima

        colima start --cpu 3 --memory 10 --disk 30 --vm-type=vz || \
        colima start --cpu 3 --memory 10 --disk 30 --vm-type=qemu

        sleep 30
        docker context use colima >/dev/null || true
        docker version
        docker ps
      displayName: 'Install and start Colima-based Docker'
      timeoutInMinutes: 15

    - script: |
        docker pull mcr.microsoft.com/mssql/server:2022-latest
        docker run \
          --name sqlserver \
          -e ACCEPT_EULA=Y \
          -e MSSQL_SA_PASSWORD="${DB_PASSWORD}" \
          -p 1433:1433 \
          -d mcr.microsoft.com/mssql/server:2022-latest

        for i in {1..30}; do
          docker exec sqlserver \
            /opt/mssql-tools18/bin/sqlcmd \
            -S localhost \
            -U SA \
            -P "$DB_PASSWORD" \
            -C -Q "SELECT 1" && break
          sleep 2
        done
      displayName: 'Pull & start SQL Server (Docker)'
      env:
        DB_PASSWORD: $(DB_PASSWORD)

    - script: |
        python -m pytest -v
      displayName: 'Run Pytest to validate bindings'
      env:
        DB_CONNECTION_STRING: 'Server=tcp:127.0.0.1,1433;Database=master;Uid=SA;Pwd=$(DB_PASSWORD);TrustServerCertificate=yes'

    - script: |
        python -m pip install --upgrade pip
        pip install wheel setuptools
        python setup.py bdist_wheel
      displayName: 'Build 3.14 universal2 whl'
    
    - task: CopyFiles@2
      inputs:
        SourceFolder: '$(Build.SourcesDirectory)/dist'
        Contents: '*.whl'
        TargetFolder: '$(Build.ArtifactStagingDirectory)/dist'
      displayName: 'Collect wheel package'
    
    - task: PublishBuildArtifacts@1
      condition: succeededOrFailed()
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)/ddbc-bindings'
        ArtifactName: 'mssql-python-ddbc-bindings-py314'
        publishLocation: 'Container'
      displayName: 'Publish .so files as artifacts'
    
    - task: PublishBuildArtifacts@1
      condition: succeededOrFailed()
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)/dist'
        ArtifactName: 'mssql-python-wheels-dist-py314'
        publishLocation: 'Container'
      displayName: 'Publish wheels as artifacts'

- job: BuildLinuxWheels_Python314
  displayName: 'Build Linux Python 3.14 -'
  pool: { vmImage: 'ubuntu-latest' }
  timeoutInMinutes: 120

  strategy:
    matrix:
      manylinux_x86_64:
        LINUX_TAG: 'manylinux'
        ARCH: 'x86_64'
        DOCKER_PLATFORM: 'linux/amd64'
        IMAGE: 'quay.io/pypa/manylinux_2_28_x86_64'
      manylinux_aarch64:
        LINUX_TAG: 'manylinux'
        ARCH: 'aarch64'
        DOCKER_PLATFORM: 'linux/arm64'
        IMAGE: 'quay.io/pypa/manylinux_2_28_aarch64'
      musllinux_x86_64:
        LINUX_TAG: 'musllinux'
        ARCH: 'x86_64'
        DOCKER_PLATFORM: 'linux/amd64'
        IMAGE: 'quay.io/pypa/musllinux_1_2_x86_64'
      musllinux_aarch64:
        LINUX_TAG: 'musllinux'
        ARCH: 'aarch64'
        DOCKER_PLATFORM: 'linux/arm64'
        IMAGE: 'quay.io/pypa/musllinux_1_2_aarch64'

  steps:
    - checkout: self
      fetchDepth: 0

    - script: |
        sudo docker run --rm --privileged tonistiigi/binfmt --install all
      displayName: 'Enable QEMU (for aarch64)'

    - script: |
        rm -rf $(Build.ArtifactStagingDirectory)/dist $(Build.ArtifactStagingDirectory)/ddbc-bindings
        mkdir -p $(Build.ArtifactStagingDirectory)/dist
        mkdir -p $(Build.ArtifactStagingDirectory)/ddbc-bindings/$(LINUX_TAG)-$(ARCH)
      displayName: 'Prepare artifact directories'

    - script: |
        docker run -d --name build-$(LINUX_TAG)-$(ARCH) \
          --platform $(DOCKER_PLATFORM) \
          -v $(Build.SourcesDirectory):/workspace \
          -w /workspace \
          $(IMAGE) \
          tail -f /dev/null
      displayName: 'Start $(LINUX_TAG) $(ARCH) container'

    - script: |
        set -euxo pipefail
        if [[ "$(LINUX_TAG)" == "manylinux" ]]; then
          docker exec build-$(LINUX_TAG)-$(ARCH) bash -lc '
            set -euxo pipefail
            if command -v dnf >/dev/null 2>&1; then
              dnf -y update || true
              dnf -y install gcc gcc-c++ make cmake unixODBC-devel krb5-libs keyutils-libs ccache || true
            elif command -v yum >/dev/null 2>&1; then
              yum -y update || true
              yum -y install gcc gcc-c++ make cmake unixODBC-devel krb5-libs keyutils-libs ccache || true
            else
              echo "No dnf/yum found in manylinux image" >&2
            fi

            echo "---- tool versions ----"
            gcc --version || true
            cmake --version || true
          '
        else
          docker exec build-$(LINUX_TAG)-$(ARCH) sh -lc '
            set -euxo pipefail
            apk update || true
            apk add --no-cache bash build-base cmake unixodbc-dev krb5-libs keyutils-libs ccache || true

            echo "---- tool versions ----"
            gcc --version || true
            cmake --version || true
          '
        fi
      displayName: 'Install system build dependencies'

    - script: |
        set -euxo pipefail
        if [[ "$(LINUX_TAG)" == "manylinux" ]]; then SHELL_EXE=bash; else SHELL_EXE=sh; fi

        docker exec build-$(LINUX_TAG)-$(ARCH) $SHELL_EXE -lc 'mkdir -p /workspace/dist'

        # Build only for Python 3.14 (cp314)
        PYBIN=cp314
        echo "=== Building for $PYBIN on $(LINUX_TAG)/$(ARCH) ==="
        if [[ "$(LINUX_TAG)" == "manylinux" ]]; then
          docker exec build-$(LINUX_TAG)-$(ARCH) bash -lc "
            set -euxo pipefail;
            PY=/opt/python/${PYBIN}-${PYBIN}/bin/python;
            test -x \$PY || { echo 'Python \$PY missing'; exit 0; }
            ln -sf \$PY /usr/local/bin/python;
            python -m pip install -U pip setuptools wheel pybind11;
            echo 'python:' \$(python -V); which python;
            cd /workspace/mssql_python/pybind;
            bash build.sh;

            cd /workspace;
            python setup.py bdist_wheel;
          "
        else
          docker exec build-$(LINUX_TAG)-$(ARCH) sh -lc "
            set -euxo pipefail;
            PY=/opt/python/${PYBIN}-${PYBIN}/bin/python;
            test -x \$PY || { echo 'Python \$PY missing'; exit 0; }
            ln -sf \$PY /usr/local/bin/python;
            python -m pip install -U pip setuptools wheel pybind11;
            echo 'python:' \$(python -V); which python;
            cd /workspace/mssql_python/pybind;
            bash build.sh;

            cd /workspace;
            python setup.py bdist_wheel;
          "
        fi
      displayName: 'Run build.sh and build wheels for Python 3.14'

    - script: |
        set -euxo pipefail
        docker cp build-$(LINUX_TAG)-$(ARCH):/workspace/dist/. "$(Build.ArtifactStagingDirectory)/dist/" || echo "No wheels to copy"

        mkdir -p "$(Build.ArtifactStagingDirectory)/ddbc-bindings/$(LINUX_TAG)-$(ARCH)"

        docker exec build-$(LINUX_TAG)-$(ARCH) $([[ "$(LINUX_TAG)" == "manylinux" ]] && echo bash -lc || echo sh -lc) '
          set -euxo pipefail;
          echo "Listing package dirs for sanity:";
          ls -la /workspace/mssql_python || true;
          ls -la /workspace/mssql_python/pybind || true;

          OUT="/tmp/ddbc-out-$(LINUX_TAG)-$(ARCH)";
          rm -rf "$OUT"; mkdir -p "$OUT";

          find /workspace/mssql_python -maxdepth 1 -type f -name "*.so" -exec cp -v {} "$OUT"/ \; || true

          echo "Top-level .so collected in $OUT:";
          ls -la "$OUT" || true
        '

        docker cp "build-$(LINUX_TAG)-$(ARCH):/tmp/ddbc-out-$(LINUX_TAG)-$(ARCH)/." \
          "$(Build.ArtifactStagingDirectory)/ddbc-bindings/$(LINUX_TAG)-$(ARCH)/" \
          || echo "No top-level .so files to copy"

        find "$(Build.ArtifactStagingDirectory)/ddbc-bindings/$(LINUX_TAG)-$(ARCH)" -maxdepth 1 -type f ! -name "*.so" -delete || true
      displayName: 'Copy wheels and .so back to host'

    - script: |
        set -euxo pipefail
        
        # Start SQL Server on host
        docker run -d --name sqlserver-$(LINUX_TAG)-$(ARCH) \
          --platform linux/amd64 \
          -e ACCEPT_EULA=Y \
          -e MSSQL_SA_PASSWORD="$(DB_PASSWORD)" \
          -p 1433:1433 \
          mcr.microsoft.com/mssql/server:2022-latest
        
        # Wait for SQL Server to be ready
        for i in {1..30}; do
          if docker exec sqlserver-$(LINUX_TAG)-$(ARCH) /opt/mssql-tools18/bin/sqlcmd \
            -S localhost -U SA -P "$(DB_PASSWORD)" -C -Q "SELECT 1" >/dev/null 2>&1; then
            echo "SQL Server is ready!"
            break
          fi
          sleep 2
        done
        
        # Get SQL Server container IP
        SQL_IP=$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' sqlserver-$(LINUX_TAG)-$(ARCH))
        echo "SQL Server IP: $SQL_IP"
        
        # Install wheel and run tests in build container
        if [[ "$(LINUX_TAG)" == "manylinux" ]]; then
          docker exec build-$(LINUX_TAG)-$(ARCH) bash -lc "
            set -ex
            PY=/opt/python/cp314-cp314/bin/python
            
            # Install the built wheel in isolated directory
            mkdir -p /test_isolated
            cd /test_isolated
            \$PY -m pip install /workspace/dist/*.whl
            
            # Verify installation
            \$PY -c 'import mssql_python; print(\"Package imported successfully from:\", mssql_python.__file__)'
            
            # Install pytest
            \$PY -m pip install pytest
            
            # Copy tests from workspace
            cp -r /workspace/tests /test_isolated/ || echo 'No tests directory'
            cp /workspace/requirements.txt /test_isolated/ || true
            \$PY -m pip install -r /test_isolated/requirements.txt || true
            
            # Run pytest
            if [ -d /test_isolated/tests ]; then
              DB_CONNECTION_STRING='Server=$SQL_IP;Database=master;Uid=SA;Pwd=$(DB_PASSWORD);TrustServerCertificate=yes' \$PY -m pytest /test_isolated/tests -v || echo 'Some tests may have failed'
            fi
          "
        else
          docker exec build-$(LINUX_TAG)-$(ARCH) sh -lc "
            set -ex
            PY=/opt/python/cp314-cp314/bin/python
            
            # Install the built wheel in isolated directory
            mkdir -p /test_isolated
            cd /test_isolated
            \$PY -m pip install /workspace/dist/*.whl
            
            # Verify installation
            \$PY -c 'import mssql_python; print(\"Package imported successfully from:\", mssql_python.__file__)'
            
            # Install pytest
            \$PY -m pip install pytest
            
            # Copy tests from workspace
            cp -r /workspace/tests /test_isolated/ || echo 'No tests directory'
            cp /workspace/requirements.txt /test_isolated/ || true
            \$PY -m pip install -r /test_isolated/requirements.txt || true
            
            # Run pytest
            if [ -d /test_isolated/tests ]; then
              DB_CONNECTION_STRING='Server=$SQL_IP;Database=master;Uid=SA;Pwd=$(DB_PASSWORD);TrustServerCertificate=yes' \$PY -m pytest /test_isolated/tests -v || echo 'Some tests may have failed'
            fi
          "
        fi
      displayName: 'Install wheel and run pytests'
      env:
        DB_PASSWORD: $(DB_PASSWORD)
      continueOnError: true

    - script: |
        docker stop build-$(LINUX_TAG)-$(ARCH) sqlserver-$(LINUX_TAG)-$(ARCH) || true
        docker rm build-$(LINUX_TAG)-$(ARCH) sqlserver-$(LINUX_TAG)-$(ARCH) || true
      displayName: 'Clean up containers'
      condition: always()

    - task: PublishBuildArtifacts@1
      condition: succeededOrFailed()
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)/dist'
        ArtifactName: 'mssql-python-wheels-dist-py314'
        publishLocation: 'Container'
      displayName: 'Publish wheels as artifacts'

    - task: PublishBuildArtifacts@1
      condition: succeededOrFailed()
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)/ddbc-bindings'
        ArtifactName: 'mssql-python-ddbc-bindings-py314'
        publishLocation: 'Container'
      displayName: 'Publish .so files as artifacts'
